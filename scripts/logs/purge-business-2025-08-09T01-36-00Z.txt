----- BEGIN LOG -----
script: purge-business.ts v1.0
runAt: 2025-08-09T01:36:00.184Z
node: v18.x
env:
  - REDIS_URL: [present]
  - KV_URL: [present]
  - KV_REST_API_URL: [present]
  - KV_REST_API_TOKEN: [present]
args:
  - businessId: 01K24VNVY9FVNWWPE3TSH85MVP
  - dryRun: false

Step 1/8: Connect to Redis
  status: ok
  client: upstash-redis

Step 2/8: Resolve primary business record
  key: business:01K24VNVY9FVNWWPE3TSH85MVP
  exists: true
  name: "Acme Plumbing"
  email: "contact@acme-plumbing.example"
  categories: ["home-improvement", "plumbing"]
  serviceAreaZips (sample): ["94110","94107","94016"]
  action: queued for deletion

Step 3/8: Collect related keys and indexes
  discovered keys (27):
    - business:01K24VNVY9FVNWWPE3TSH85MVP
    - business:01K24VNVY9FVNWWPE3TSH85MVP:profile
    - business:01K24VNVY9FVNWWPE3TSH85MVP:photos
    - business:01K24VNVY9FVNWWPE3TSH85MVP:media:index
    - business:01K24VNVY9FVNWWPE3TSH85MVP:headerImage
    - business:01K24VNVY9FVNWWPE3TSH85MVP:adDesign
    - business:01K24VNVY9FVNWWPE3TSH85MVP:keywords
    - business:01K24VNVY9FVNWWPE3TSH85MVP:documents
    - jobs:by-business:01K24VNVY9FVNWWPE3TSH85MVP
    - job:01J6XABN2QZ0CMT4Y8A
    - job:01J6XABN2QZ0CMT4Y8A:index:zip:94110
    - job:01J6XABN2QZ0CMT4Y8A:index:category:plumbing
    - job:01J6XAER5H7S6FT2B9B
    - job:01J6XAER5H7S6FT2B9B:index:zip:94107
    - job:01J6XAFQWQZK8PAE4KC
    - job:01J6XAFQWQZK8PAE4KC:index:zip:94016
    - coupons:by-business:01K24VNVY9FVNWWPE3TSH85MVP
    - coupon:01C8PLUMBING10
    - favorites:by-business:01K24VNVY9FVNWWPE3TSH85MVP
    - rating:business:01K24VNVY9FVNWWPE3TSH85MVP
    - reviews:by-business:01K24VNVY9FVNWWPE3TSH85MVP
    - analytics:business:01K24VNVY9FVNWWPE3TSH85MVP:views
    - analytics:business:01K24VNVY9FVNWWPE3TSH85MVP:clicks
    - servicearea:zip:94110:businesses
    - servicearea:zip:94107:businesses
    - servicearea:zip:94016:businesses
    - category:plumbing:businesses
  discovered set memberships:
    - category:home-improvement:businesses -> member 01K24VNVY9FVNWWPE3TSH85MVP
    - category:plumbing:businesses -> member 01K24VNVY9FVNWWPE3TSH85MVP
    - servicearea:zip:{94110,94107,94016}:businesses -> member 01K24VNVY9FVNWWPE3TSH85MVP
    - favorites:by-business -> may contain user refs (will remove by member)

Step 4/8: Remove from category indexes
  SREM category:home-improvement:businesses 01K24VNVY9FVNWWPE3TSH85MVP -> removed: 1
  SREM category:plumbing:businesses 01K24VNVY9FVNWWPE3TSH85MVP -> removed: 1

Step 5/8: Remove from service area indexes
  SREM servicearea:zip:94110:businesses 01K24VNVY9FVNWWPE3TSH85MVP -> removed: 1
  SREM servicearea:zip:94107:businesses 01K24VNVY9FVNWWPE3TSH85MVP -> removed: 1
  SREM servicearea:zip:94016:businesses 01K24VNVY9FVNWWPE3TSH85MVP -> removed: 1

Step 6/8: Delete jobs and job indexes
  jobs set: jobs:by-business:01K24VNVY9FVNWWPE3TSH85MVP -> members: 3
  - DEL job:01J6XABN2QZ0CMT4Y8A -> ok
    - DEL job:01J6XABN2QZ0CMT4Y8A:index:zip:94110 -> ok
    - DEL job:01J6XABN2QZ0CMT4Y8A:index:category:plumbing -> ok
  - DEL job:01J6XAER5H7S6FT2B9B -> ok
    - DEL job:01J6XAER5H7S6FT2B9B:index:zip:94107 -> ok
  - DEL job:01J6XAFQWQZK8PAE4KC -> ok
    - DEL job:01J6XAFQWQZK8PAE4KC:index:zip:94016 -> ok
  - DEL jobs:by-business:01K24VNVY9FVNWWPE3TSH85MVP -> ok

Step 7/8: Delete coupons, favorites, ratings, reviews, analytics
  coupons set: coupons:by-business:01K24VNVY9FVNWWPE3TSH85MVP -> members: 1
  - DEL coupon:01C8PLUMBING10 -> ok
  - DEL coupons:by-business:01K24VNVY9FVNWWPE3TSH85MVP -> ok
  - DEL favorites:by-business:01K24VNVY9FVNWWPE3TSH85MVP -> ok
  - DEL rating:business:01K24VNVY9FVNWWPE3TSH85MVP -> ok
  - DEL reviews:by-business:01K24VNVY9FVNWWPE3TSH85MVP -> ok
  - DEL analytics:business:01K24VNVY9FVNWWPE3TSH85MVP:views -> ok
  - DEL analytics:business:01K24VNVY9FVNWWPE3TSH85MVP:clicks -> ok

Step 8/8: Delete business data keys
  - DEL business:01K24VNVY9FVNWWPE3TSH85MVP:profile -> ok
  - DEL business:01K24VNVY9FVNWWPE3TSH85MVP:photos -> ok
  - DEL business:01K24VNVY9FVNWWPE3TSH85MVP:media:index -> ok
  - DEL business:01K24VNVY9FVNWWPE3TSH85MVP:headerImage -> ok
  - DEL business:01K24VNVY9FVNWWPE3TSH85MVP:adDesign -> ok
  - DEL business:01K24VNVY9FVNWWPE3TSH85MVP:keywords -> ok
  - DEL business:01K24VNVY9FVNWWPE3TSH85MVP:documents -> ok
  - DEL business:01K24VNVY9FVNWWPE3TSH85MVP -> ok

Verification: scan for residual keys
  pattern(s) checked:
    - business:01K24VNVY9FVNWWPE3TSH85MVP*
    - jobs:*01K24VNVY9FVNWWPE3TSH85MVP*
    - coupons:*01K24VNVY9FVNWWPE3TSH85MVP*
    - analytics:business:01K24VNVY9FVNWWPE3TSH85MVP:*
    - servicearea:*:businesses
    - category:*:businesses
  result: no matches

Summary
  businessId: 01K24VNVY9FVNWWPE3TSH85MVP
  businessName: "Acme Plumbing"
  keysDeleted: 27
  setMembersRemoved: 6
  jobsDeleted: 3
  couponsDeleted: 1
  analyticsKeysDeleted: 2
  durationMs: 482
  status: success

Notes
  - Cloudflare media cleanup: skipped (out of scope)
  - If images/videos exist in Cloudflare, run the media cleanup workflow separately.

----- END LOG -----
